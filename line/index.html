<!DOCTYPE html>
<html lang="en">

<head>
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <title></title>

    <meta name="description" content="Interactive calculator to show what factors affect the ratio of pensioners to people of working age">
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge" /> -->
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no" />
    <!-- <meta http-equiv="content-type" content="text/html; charset=utf-8" /> -->

    <link rel="stylesheet" href="../lib/globalStyle.css" />
    <link rel="stylesheet" href="bootstrap-grid.css"/>
    <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous"> -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">


    <!-- <link rel="stylesheet" href="global.css"/>
    <link rel="stylesheet" href="https://cdn.ons.gov.uk/sixteens/a62dd01/css/main.css"/> -->

    <style>
      body{
        font-family: 'Open Sans', helvetica, arial, sans-serif;
      }
      .line{
        shape-rendering:"crispEdges";
      }
      svg{overflow: visible;}
      h2{
        font-size: 30px;
        line-height:40px;
        font-weight: 700;
        margin:40px 0 0 0;
        padding:3px 0 5px 0
      }
      p{
        /* line-height: 24px; */
        font-size: 18px;
        margin:0;
        padding: 0;
      }
      input{
        border: none;
        border-radius: 0;
        /* border: 2px solid #1b5f97; */
        font-size: 18px;
        /* line-height: 27px; */
        width:55px;
        /* margin:16px 0;
        padding: 6px 0 0 0;
        width:60px;*/
        text-align: center;
      }

      input:focus{
        outline:3px solid #FFA23A;
        z-index: 1;
        outline-offset: -2px;
      }

      input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
      }

      input[type="number"]{
          -moz-appearance: textfield;
      }
      .slider text{
        font-size: 18px;
      }

      .axis text{
        font-size: 18px;
      }
      #legend{
        margin-bottom: 10px;
      }
      .parameter-value path{
        fill:#0F8243;
        stroke:white;
        stroke-width:1.5px;
      }
      .parameter-value path:focus{
        fill:#0F8243;
        stroke:orange;
        stroke-width:3px;
      }
      .bold{
        font-weight: 700;
        color: #206595;
        /* font-size:20px; */
      }


    /* Button */

    .btn--primary {
    background-color: #206095 !important;
    }
    .btn {
        position: relative;
        padding: 10px 15px;
        margin: 0 0 20px;
        line-height: normal;
        color: #fff;
        font-size: 1.3em !important;
        border-radius: 0px;
        display: inline-block;
        text-rendering: optimizeLegibility;
        transition: background-color .2s ease-in, color .2s ease-in;
    }
    .btn--primary {
        background-color: #0F8243;
        color: #fff;
    }
    .btn {
        font-family: "Open Sans",Helvetica,Arial,sans-serif;
        font-weight: 400;
        font-size: 14px;
        display: inline-block;
        width: auto;
        cursor: pointer;
        padding: 6px 16px 10px 16px;
        border: 0 none;
        text-align: center;
        -webkit-appearance: none;
        transition: background-color 0.25s ease-out;
        text-decoration: none;
        line-height: 24px;
    }
    .btn {
        display: inline-block;
        padding: 6px 12px;
        margin-bottom: 0;
        font-size: 14px;
        font-weight: 400;
        line-height: 1.42857143;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        -ms-touch-action: manipulation;
        touch-action: manipulation;
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        background-image: none;
        border: 1px solid transparent;
        border-radius: 4px;
    }
    button {
        cursor: pointer;
    }

    .btn--previous::before {
      font-family: "Font Awesome 5 Free";
      font-weight: 900;
      content: "\f053";
      margin-right: 10px;
    }

    .btn--next{
      float:right;
    }
    .btn--next::after {
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        content: "\f054";
        margin-left: 10px;
    }

    button#minus.minus, button#plus.plus {
    width: 1.4em;
    height: 1.4em;
    background-color: #1b5f97;
    color: #fff;
    border: 2px solid #1b5f97;
    box-sizing: border-box;
    font-size: 19px;
    text-align: center;
    cursor: pointer;
    font-weight: bold;
    }

    .borderbox {
    border: 2px solid #1b5f97;
    /* padding-top:5px; */
    /* padding-bottom: 1px; */
    /*padding-left: 0px;
    padding-right: 0px;
    display: flex;
    align-items: center;
    max-width: 160px;
    float: none;*/
    }
    button:focus {
      outline: 3px solid #f93;
    }

    .error_message {
      padding: 8px;
      border: solid 3px #206095;
    }
    .error_title {
        font-weight: bold;
        font-size: 1.2em;
        padding: 0;
        margin-top: 0;
    }

    .error_text{
      font-weight: 400;
    }

    /* Tooltip */
    .fas {
      color: #206095;
      /* font-size: 2em;  */
    }

      #tooltip {
        background: #206095;
        color: #fff;
        font-family: 'Open Sans';
        font-weight:400;
        border: 0px solid black;
        border-radius: 5px;
        padding: 5px;
        width: 150px;
        text-align:center;
        pointer-events: none;
      }

      #tooltip::after {
          content: " ";
          position: absolute;
          bottom: 100%;
          left: 50%;
          margin-left: -18px;
          border-width: 5px;
          border-style: solid;
          border-color: transparent transparent #206095 transparent;
        }

        .tooltipleft::after {
            left: 26px !important;
        }

        .tooltipright::after {
            left: 155px !important;
        }

    div.results_box h3{
      padding-bottom: 20px;
      font-size: 24px;
      border-bottom: 3px solid #206095;
    }

    div.results_text--outline p{
      line-height: 1.5em;
      border-bottom: 3px solid #206095;
      padding-bottom: 8px;
      padding-top: 5px;
    }

    #boxtext1,#boxtext2,#boxtext3,#boxtext4,#boxtext5{
      color:#206095;
      font-weight:700;
    }
    .green{
      color:#339a59;
      font-weight: 400;
      font-size: 16px;
    }

    #keypoints {
      margin-bottom: 50px;
    }

    /* .col-md-3{
      max-width:
    } */
    @media (min-width: 767px){
      .title{
         height:70px;
      }

      .slider-col{
        border-right: 1px solid #ccc;
      }
    }

    @media (max-width:768px){
      .title{
        padding-bottom: 10px;
      }
    }
    #counter{
      margin-bottom:10px;
    }

    #graphHeader {
      font-size: 20px;
      font-weight: 700;
      color:#206095;
      padding-bottom: 14px;
    }

    input
    {
        background: transparent;
        border: none;
    }


    </style>
</head>


<body>
  <div style="max-width:768px;margin:auto;">
    <h1>Lorem ipsum</h1>
    <div id="counter" class="bold d-md-none d-block"><span id="counternum">1</span>/4</div>
      <div id="sliders" class="container" style="margin-bottom:20px">
        <div class="row" style="margin-right: -0px;margin-left: -15px;">
          <div id="column0" class="col col-12 col-md-3 slider-col">
            <div class="container">
              <div class="row">
                <div class="col-12 title"><p class='bold'>Life expectancy in 2042 <span class="fas fa-info-circle test" id="icon1"></span><br/></p></div>
                <div class="col-12"><div id="slider-mortality"></div></div>
              </div>
            </div>
          </div>

          <div id="column1" class="container col col-12 col-md-3 slider-col">
            <div class="row no-gutters">
              <div class="col-md-12 title"><p class='bold'>Annual net migration by 2042 <span class="fas fa-info-circle test" id="icon2"></span><br/><span class="green">▬ 2017:283,000</span></p></div>
              <div class="col-md-12"><div id="slider-simple"></div></div>
            </div>
          </div>

          <div id="column2" class="container col col-12 col-md-3 slider-col">
            <div class="row no-gutters">
              <div class="col-md-12 title"><p class='bold' >Children per woman by 2042 <span class="fas fa-info-circle test" id="icon3"></span><br/><span class="green">▬ 2017:1.75</span></p></div>
              <div class="col-md-12"><div id="slider-women"></div></div>
            </div>
          </div>

          <div id="column3" class="container col col-12 col-md-3">
            <div class="row no-gutters">
              <div class="col-md-12 title"><p class='bold'>At
                    <span class="borderbox"><span><button type="button" id="minus" class="minus">-</button></span>
                    <span style="text-align: center;"><input class="bold" id="year" type="number" value="2028" max="2042" min="2017"></span>
                    <span><button type="button" id="plus" class="plus">+</button></span></span>
                 the state pension age will be</p></div>
              <div class="col-md-12"><div id="slider-pension"></div></div>
            </div>
          </div>

        </div>
      </div>
  <!-- Next Prev buttons -->
  <div class="container-fluid no-gutters d-md-none d-block">
    <div class="row no-gutters" style="margin-right: -0px;margin-left: -15px;">
      <div id="previous" class="col-3 "><button class="btn btn-group__btn btn--primary btn--green btn--previous">Previous</button></div>
      <div id="next" class="col-3 offset-6"><button class="btn btn-group__btn btn--primary btn--green btn--next">Next</button></div>
    </div>
  </div>

  <!-- Results block -->
      <div class="container-fluid" style="padding-left:0px;padding-right:0px; margin-top:40px;">
        <div class="row" style="margin-right: -0px;margin-left: -15px;">
          <div class="col-md-8 order-2 order-md-1">
            <div id="graphHeader">Number of pensioners per 1,000 people of working age</div>
            <div id="graphic">
            	<!-- <img src="fallback.png" alt="[Chart]" /> -->
             </div>
          </div>
          <div class="col-md-4 order-1 order-md-2">
            <div id="keypoints">
              <div class="results_box results_box--outline">
                 <h3 class="bold">Based on your selection…</h3>
                 <div class="results_text--outline">
                   <p class="error_text">In 2042, there will be <span id="boxtext1">367</span> pensioners per 1,000 people of working age.
                   </p>

                   <p class="error_text">This is <span id='boxtext4'>67</span> <span id='boxtext5'>more than in</span> 2016.
                   </p>
                   <p class="error_text">This will <span id="boxtext2">increase</span> our spending on state pensions.
                   </p>
                 </div>
               </div>
            </div>
          </div>

        </div>
      </div>

      <div id="tooltip" display="none" style="position: absolute; opacity: 0;"></div>
   </div>


   <input id="mortalityHidden" type="hidden" value=2>
   <input id="migrationHidden" type="hidden" value=165000>
   <input id="fertilityHidden" type="hidden" value="1.84">
   <input id="yearHidden" type="hidden" value="2028">
   <input id="pensionHidden" type="hidden" value="67">
   <input id="buttonCounter" type="hidden" value="0">

    <script src="https://unpkg.com/unfetch/polyfill"></script>
    <script src="https://cdn.ons.gov.uk/vendor/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.4/bluebird.min.js"></script>
    <!-- <script src="https://d3js.org/d3-queue.v3.min.js"></script> -->
    <script src="d3-simple-slider.js"></script>
 		<script src="../lib/modernizr.svg.min.js" type="text/javascript"></script>
 		<script src="../lib/pym.js" type="text/javascript"></script>

    <script>

    </script>


   <script>

    width=document.body.clientWidth
    sliderwidth=parseInt(d3.select("#sliders").style("width"))
		var graphic = d3.select('#graphic');
		var keypoints = d3.select('#keypoints');
		var footer = d3.select(".footer");
		var pymChild = null;



    //next previous buttons
    d3.select("#next").on('click',function(){
      var currentbutton = +document.getElementById('buttonCounter').value
      d3.select("#column"+currentbutton).style("display","none")
      var newbutton = currentbutton+1;
      if(newbutton==4){newbutton=0}
      document.getElementById('buttonCounter').value=newbutton
      d3.select("#counternum").html(newbutton+1)
      d3.select("#column"+newbutton).style("display","block")
    })

    d3.select("#previous").on('click',function(){
      var currentbutton = +document.getElementById('buttonCounter').value
      d3.select("#column"+currentbutton).style("display","none")
      var newbutton = currentbutton-1;
      if(newbutton==-1){newbutton=3}
      document.getElementById('buttonCounter').value=newbutton
      d3.select("#counternum").html(newbutton+1)
      d3.select("#column"+newbutton).style("display","block")
    })

    //tooltip
     d3.select('#icon1')
      .data([{"tooltipText":"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec mollis nulla purus. Etiam aliquam sit amet dolor vel ullamcorper. ","id":"icon1"}])
      .on('mouseover',function(d){showTooltip(d)})
      .on('mouseout',function(d){hideTooltip(d)})

      d3.select('#icon2')
       .data([{"tooltipText":"Sed euismod urna non tristique euismod. Quisque auctor dui arcu, sit amet porta dui ornare sit amet. ","id":"icon2"}])
       .on('mouseover',function(d){showTooltip(d)})
       .on('mouseout',function(d){hideTooltip(d)})

       d3.select('#icon3')
        .data([{"tooltipText":"Donec at maximus turpis, in sagittis enim. Curabitur maximus rhoncus hendrerit. Fusce suscipit sit amet mauris nec vehicula.","id":"icon3"}])
        .on('mouseover',function(d){showTooltip(d)})
        .on('mouseout',function(d){hideTooltip(d)})

      function showTooltip(d){
        var boundingRect=document.getElementById(d.id).getBoundingClientRect()
        console.log(boundingRect)
        if(boundingRect.x>width/2){
          d3.select("#tooltip")
            .classed("tooltipright",true)
            .classed("tooltipleft",false)
            .style("left", (boundingRect.x-135+2)+"px")
            .style("top", (boundingRect.y+25)+"px")
            .text(d.tooltipText)
            .transition()
            .duration(300)
            .style("opacity","1");
        }else{
          d3.select("#tooltip")
            .classed("tooltipright",false)
            .classed("tooltipleft",true)
            .style("left", (boundingRect.x-2)+"px")
            .style("top", (boundingRect.y+25)+"px")
            .text(d.tooltipText)
            .transition()
            .duration(300)
            .style("opacity","1");
        }
      }

      function hideTooltip(){
        d3.select("#tooltip")
        .transition()
        .duration(300)
        .style("opacity","0");

        window.setTimeout(function(){d3.select("#tooltip")
        .style("left","")
        .style("right","")},301)
      }

     //stuff for the tally
     document.getElementById("plus").addEventListener("click", function() {
       var typenumber = document.getElementById("year").value
       if(typenumber+1<=document.getElementById("year").max){
         document.getElementById("year").value = +typenumber + 1;
         document.getElementById("yearHidden").value = +typenumber + 1;
         d3.select("#year").on('change')()
       }
      })
      document.getElementById("minus").addEventListener("click", function() {
       if (document.getElementById("year").value > 0) {
         var typenumber = document.getElementById("year").value
         if(typenumber-1>=document.getElementById("year").min){
           document.getElementById("year").value = +typenumber - 1;
           document.getElementById("yearHidden").value = +typenumber - 1;
           d3.select("#year").on('change')()
         }
       }
      })


    if(width>767){
      var sliderSimple = d3
        .sliderRight()
        .min(0)
        .max(600000)
        .height(175)
        .tickFormat(d3.format(',.0f'))
        .ticks(5)
        .step(1000)
        .default(165000)
        .startingText("")
        .startingValue(283000)
        .handle(
          d3.symbol()
            .type(d3.symbolCircle)
            .size(500)
        )
        .fill("#206595")
        .on('onchange', _.throttle(function(val){
        //   d3.select("#value-simple").on('change')() //call the change event https://stackoverflow.com/questions/32610092/why-isnt-the-checkbox-change-event-triggered-when-i-do-it-programatically-in-d3
        //
        var svg = d3.select('#graphic').select('svg')
        document.getElementById('migrationHidden').value=val;

        slidervalues=getSliderValues()
        var newOADR=runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,slidervalues[0],slidervalues[1],slidervalues[2],slidervalues[3])

        d3.select('#graphic path.line')
            .attr('stroke-dasharray','5 5')
            .style("stroke", "grey")

        updateText(newOADR)
        }),100);

      var gSimple = d3
        .select('div#slider-simple')
        .append('svg')
        .attr('height', 220)
        .append('g')
        .attr('transform', 'translate(60,50)');

      gSimple.call(sliderSimple);


      //women sliders
      var sliderWomen = d3
        .sliderRight()
        .min(0)
        .max(5)
        .height(175)
        .tickFormat(d3.format(',.2f'))
        .ticks(5)
        .step(0.01)
        .default(1.84)
        .startingText("")
        .startingValue(1.75)
        .handle(
          d3.symbol()
            .type(d3.symbolCircle)
            .size(500)
        )
        .fill("#206595")
        .on('onchange', _.throttle(function(val){
        //   d3.select("#value-women").on('change')()
        var svg = d3.select('#graphic').select('svg')
        document.getElementById('fertilityHidden').value=val;

        slidervalues=getSliderValues()

        var newOADR=runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,slidervalues[0],slidervalues[1],slidervalues[2],slidervalues[3])

        svg.select('.line')
            .attr('stroke-dasharray','5 5')
            .style("stroke", "grey")

        updateText(newOADR)

        }),100);

      var gSimple2 = d3
        .select('div#slider-women')
        .append('svg')
        .attr('height', 220)
        .append('g')
        .attr('transform', 'translate(60,50)');

      gSimple2.call(sliderWomen);


      //pension slider
      var sliderPension = d3
        .sliderRight()
        .min(60)
        .max(80)
        .height(175)
        .tickFormat(d3.format(',.0f'))
        .ticks(5)
        .step(1)
        .default(67)
        .startingText("")
        .handle(
          d3.symbol()
            .type(d3.symbolCircle)
            .size(500)
        )
        .fill("#206595")
        .on('onchange', _.throttle(function(val){
        //  d3.select("#value-pension").on('change')()
          var svg = d3.select('#graphic').select('svg')
          document.getElementById('pensionHidden').value=val;

          slidervalues=getSliderValues()

          var newOADR=runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,slidervalues[0],slidervalues[1],slidervalues[2],slidervalues[3])

          svg.select('.line')
              .attr('stroke-dasharray','5 5')
              .style("stroke", "grey")

          updateText(newOADR)

        }),100);

      var gSimple3 = d3
        .select('div#slider-pension')
        .append('svg')
        .attr('height', 220)
        .append('g')
        .attr('transform', 'translate(60,50)');

      gSimple3.call(sliderPension);

      //mortality sliders
      ticks=["low","medium low","principal","medium high","high"]
      ticksLeft=["81.6","82.4","83.4","84.1","84.6"]
      ticksRight=["84.5","85.3","86.2","86.9","87.2"]

      var sliderMortality = d3
          .sliderLeftRight()
          .max(4)
          .min(0)
          .height(175)
          .tickFormat(function(d,i){return ticksRight[i]})
          .ticks(5)
          .step(1)
          .default(2)
          .startingText("")
          .handle(
            d3.symbol()
              .type(d3.symbolCircle)
              .size(500)
          )
          .fill("#206595")
          .on('onchange', _.throttle(function(val){
            var svg = d3.select('#graphic').select('svg')
            document.getElementById('mortalityHidden').value=val;

            //change text in bubbles
            d3.select('div#slider-mortality').select(".parameter-value").select('text').text(ticksRight[sliderMortality.value()])
            d3.select('div#slider-mortality').select(".parameter-value").select('#textLeft').text(ticksLeft[sliderMortality.value()])

            slidervalues=getSliderValues()
              if(slidervalues[4]!=mortalityprofile){
                //load new mortality profiles
                  malemortality=malemortalitydata[slidervalues[4].replace(/\s/g,'')]
                  femalemortality=femalemortalitydata[slidervalues[4].replace(/\s/g,'')]

                  //do some reformatting of the data
                  malemortality.forEach(function(d,i){
                    for(var column in malemortality[0]){
                      malemortality[i][column]=+malemortality[i][column]
                    }
                  })

                  femalemortality.forEach(function(d,i){
                    for(var column in femalemortality[0]){
                      femalemortality[i][column]=+femalemortality[i][column]
                    }
                  })

                  var newOADR=runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,slidervalues[0],slidervalues[1],slidervalues[2],slidervalues[3])

                  svg.select('.line')
                      .attr('stroke-dasharray','5 5')
                      .style("stroke", "grey")

                  updateText(newOADR)

                  mortalityprofile=slidervalues[4]

              }else{
                //just use the existing mortality profiles
                var newOADR=runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,slidervalues[0],slidervalues[1],slidervalues[2],slidervalues[3])

                svg.select('.line')
                    .attr('stroke-dasharray','5 5')
                    .style("stroke", "grey")

                updateText(newOADR)

                //set the mortalityprofile
                mortalityprofile=slidervalues[4]
              }
          }),100);

      var gSimple4 = d3
        .select('div#slider-mortality')
        .append('svg')
        .attr('height', 220)
        .append('g')
        .attr('transform', 'translate(70,50)');

      gSimple4.call(sliderMortality);

      //male & female labels
      gSimple4.append('text').text("Males").attr("x",-18).attr("y",-18).attr('text-anchor','end').attr('fill','#58595B')
      gSimple4.append('text').text("Females").attr("x",15).attr("y",-18).attr('text-anchor','start').attr('fill','#58595B')

      //custom ticks for the left
      d3.select('div#slider-mortality').select('.axis').selectAll('.tick text').attr('text-anchor','start')
      d3.select('div#slider-mortality').select('.axis2').selectAll('.tick text')
      .attr('font-size',18)
      .attr('fill',"#aaa")
      .attr('x',-18)
      .text(function(d,i){return ticksLeft[i]})

      d3.select('div#slider-mortality').select('.axis2').selectAll('.tick line')
      .attr('stroke',"#aaa")

      //bubble for the right
      var textRight=d3.select('div#slider-mortality').select(".parameter-value").select('text').text(ticksRight[sliderMortality.value()])
      bbox=d3.select('div#slider-mortality').select(".parameter-value").select('text').node().getBBox();
      d3.select('div#slider-mortality').select(".parameter-value").select('rect')
      .attr("x", bbox.x - 5)
      .attr("y", bbox.y - 5)
      .attr("ry",5)
      .attr("width", bbox.width + (5*2))
      .attr("height", bbox.height + (5*2))
      .style("fill", "#206095");

      //bubble for the left
      d3.select('div#slider-mortality').select(".parameter-value").append('rect')
      .attr('id','rectLeft')
      .attr("x", bbox.x - 5-90)
      .attr("y", bbox.y - 5)
      .attr("ry",5)
      .attr("width", bbox.width + (5*2))
      .attr("height", bbox.height + (5*2))
      .style("fill", "#206095");

      d3.select('div#slider-mortality').select(".parameter-value").append('text')
      .attr('id','textLeft')
      .text(ticksLeft[sliderMortality.value()])
      .attr('font-weight',700)
      .style('fill','white')
      .attr('y',textRight.attr('y'))
      .attr('x',textRight.attr('x')-90)
      .attr('dy',textRight.attr('dy'))

      //
      //
      //
      // end of desktop sliders
      //
      //
      //
    }else{
      //
      //
      //
      // mobile sliders
      //
      //
      //

      var sliderSimple = d3
        .sliderBottom()
        .min(0)
        .max(600000)
        .width(width-80)
        .tickFormat(d3.format(',.0f'))
        .ticks(5)
        .step(1000)
        .default(165000)
        .startingText("")
        .startingValue(283000)
        .handle(
          d3.symbol()
            .type(d3.symbolCircle)
            .size(500)
        )
        .fill("#206595")
        .on('onchange', _.throttle(function(val){
        var svg = d3.select('#graphic').select('svg')
        document.getElementById('migrationHidden').value=val;

        slidervalues=getSliderValues()

        var newOADR=runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,slidervalues[0],slidervalues[1],slidervalues[2],slidervalues[3])

        d3.select('#graphic path.line')
            .attr('stroke-dasharray','5 5')
            .style("stroke", "grey")

        updateText(newOADR)

      }),300);

      var gSimple = d3
        .select('div#slider-simple')
        .append('svg')
        .attr('height', 110)
        .attr('width',width)
        .append('g')
        .attr('transform', 'translate(30,40)');

      if(width<500){sliderSimple.ticks(3)}

      gSimple.call(sliderSimple);

      //women sliders
      var sliderWomen = d3
        .sliderBottom()
        .min(0)
        .max(5)
        .width(width-80)
        .tickFormat(d3.format(',.2f'))
        .ticks(5)
        .step(0.01)
        .default(1.84)
        .startingText("")
        .startingValue("1.75")
        .handle(
          d3.symbol()
            .type(d3.symbolCircle)
            .size(500)
        )
        .fill("#206595")
        .on('onchange', _.throttle(function(val){
        //   d3.select("#value-women").on('change')()
        var svg = d3.select('#graphic').select('svg')
        document.getElementById('fertilityHidden').value=val;

        slidervalues=getSliderValues()

        var newOADR=runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,slidervalues[0],slidervalues[1],slidervalues[2],slidervalues[3])

        svg.select('.line')
            .attr('stroke-dasharray','5 5')
            .style("stroke", "grey")

        updateText(newOADR)

      }),300);

      var gSimple2 = d3
        .select('div#slider-women')
        .append('svg')
        .attr('height', 100)
        .attr('width',width)
        .append('g')
        .attr('transform', 'translate(30,40)');

      gSimple2.call(sliderWomen);


      //pension slider
      var sliderPension = d3
        .sliderBottom()
        .min(60)
        .max(80)
        .width(width-80)
        .tickFormat(d3.format(',.0f'))
        .ticks(5)
        .step(1)
        .default(67)
        .startingText("")
        .handle(
          d3.symbol()
            .type(d3.symbolCircle)
            .size(500)
        )
        .fill("#206595")
        .on('onchange', _.throttle(function(val){
        //  d3.select("#value-pension").on('change')()
          var svg = d3.select('#graphic').select('svg')
          document.getElementById('pensionHidden').value=val;

          slidervalues=getSliderValues()

          var newOADR=runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,slidervalues[0],slidervalues[1],slidervalues[2],slidervalues[3])

          svg.select('.line')
              .attr('stroke-dasharray','5 5')
              .style("stroke", "grey")

          updateText(newOADR)

        }),300);

      var gSimple3 = d3
        .select('div#slider-pension')
        .append('svg')
        .attr('height', 100)
        .attr('width',width)
        .append('g')
        .attr('transform', 'translate(30,40)');

      gSimple3.call(sliderPension);

      //mortality sliders
      ticks=["low","medium low","principal","medium high","high"]
      ticksLeft=["81.6","82.4","83.4","84.1","84.6"]
      ticksRight=["84.5","85.3","86.2","86.9","87.2"]

      var sliderMortality = d3
          .sliderTopBottom()
          .max(4)
          .min(0)
          .width(width-80)
          .tickFormat(function(d,i){return ticksRight[i]})
          .ticks(5)
          .step(1)
          .default(2)
          .startingText("")
          .handle(
            d3.symbol()
              .type(d3.symbolCircle)
              .size(500)
          )
          .fill("#206595")
          .on('onchange', _.throttle(function(val){
            var svg = d3.select('#graphic').select('svg')
            document.getElementById('mortalityHidden').value=val;


            //change text in bubbles
            d3.select('div#slider-mortality').select(".parameter-value").select('text').text(ticksRight[sliderMortality.value()])
            d3.select('div#slider-mortality').select(".parameter-value").select('#textLeft').text(ticksLeft[sliderMortality.value()])

            slidervalues=getSliderValues()
              if(slidervalues[4]!=mortalityprofile){
                //load new mortality profiles
                  malemortality=malemortalitydata[slidervalues[4].replace(/\s/g,'')]
                  femalemortality=femalemortalitydata[slidervalues[4].replace(/\s/g,'')]

                  //do some reformatting of the data
                  malemortality.forEach(function(d,i){
                    for(var column in malemortality[0]){
                      malemortality[i][column]=+malemortality[i][column]
                    }
                  })

                  femalemortality.forEach(function(d,i){
                    for(var column in femalemortality[0]){
                      femalemortality[i][column]=+femalemortality[i][column]
                    }
                  })

                  var newOADR=runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,slidervalues[0],slidervalues[1],slidervalues[2],slidervalues[3])

                  svg.select('.line')
                      .attr('stroke-dasharray','5 5')
                      .style("stroke", "grey")

                  svg.select('.newline').transition().ease(d3.easeCubic).duration(500)
                      .attr('d', line(newOADR))

                  svg.select('#endcircle').transition().ease(d3.easeCubic).duration(500)
                    .attr('cy',y(newOADR[newOADR.length-1].oadr))

                  updateText(newOADR)

                  mortalityprofile=slidervalues[4]

              }else{
                //just use the existing mortality profiles
                var newOADR=runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,slidervalues[0],slidervalues[1],slidervalues[2],slidervalues[3])

                svg.select('.line')
                    .attr('stroke-dasharray','5 5')
                    .style("stroke", "grey")

                svg.select('.newline').transition().ease(d3.easeCubic).duration(500)
                    .attr('d', line(newOADR))

                svg.select('#endcircle').transition().ease(d3.easeCubic).duration(500)
                  .attr('cy',y(newOADR[newOADR.length-1].oadr))

                updateText(newOADR)

                //set the mortalityprofile
                mortalityprofile=slidervalues[4]
              }
          }),300);

      var gSimple4 = d3
        .select('div#slider-mortality')
        .append('svg')
        .attr('width',width)
        .attr('height', 120)
        .append('g')
        .attr('transform', 'translate(30,50)');

      gSimple4.call(sliderMortality);

      //male & female labels
      gSimple4.append('text').text("Females").attr("x",-16).attr("y",-15).attr('text-anchor','start').attr('fill','#58595B')
      gSimple4.append('text').text("Males").attr("x",-16).attr("y",22).attr('text-anchor','start').attr('fill','#58595B')

      //custom ticks for the left/bottom
      d3.select('div#slider-mortality').select('.axis').selectAll('.tick text').attr('text-anchor','middle')

      d3.select('div#slider-mortality').select('.axis').selectAll('.tick text').attr('y','-30')

      d3.select('div#slider-mortality').select('.parameter-value').select('text').attr('y',-36)


      d3.select('div#slider-mortality').select('.axis2').selectAll('.tick text')
      .attr('font-size',18)
      .attr('fill',"#aaa")
      .attr('y',+36)
      .attr('text-anchor','middle')
      .text(function(d,i){return ticksLeft[i]})

      d3.select('div#slider-mortality').select('.axis2').selectAll('line').attr('y2','18')


      d3.select('div#slider-mortality').select('.axis2').selectAll('.tick line')
      .attr('stroke',"#aaa")

      //bubble for the right/top
      var textRight=d3.select('div#slider-mortality').select(".parameter-value").select('text').text(ticksRight[sliderMortality.value()])
      bbox=d3.select('div#slider-mortality').select(".parameter-value").select('text').node().getBBox();
      d3.select('div#slider-mortality').select(".parameter-value").select('rect')
      .attr("x", bbox.x - 5)
      .attr("y", bbox.y - 5)
      .attr("ry",5)
      .attr("width", bbox.width + (5*2))
      .attr("height", bbox.height + (5*2))
      .style("fill", "#206095");

      //bubble for the left
      d3.select('div#slider-mortality').select(".parameter-value").append('rect')
      .attr('id','rectLeft')
      .attr("x", bbox.x - 5)
      .attr("y", + 22)
      .attr("ry",5)
      .attr("width", bbox.width + (5*2))
      .attr("height", bbox.height + (5*2))
      .style("fill", "#206095");

      d3.select('div#slider-mortality').select(".parameter-value").append('text')
      .attr('id','textLeft')
      .text(ticksLeft[sliderMortality.value()])
      .attr('font-weight',700)
      .style('fill','white')
      .attr('y',36)
      .attr('x',textRight.attr('x'))
      .attr('dy',textRight.attr('dy'))

      //now hide all but one of the sliders
      document.getElementById('buttonCounter').value=0;
      d3.select("#column3").style("display","none")
      d3.select("#column2").style("display","none")
      d3.select("#column1").style("display","none")

    }//end else mobile

    //select all handles and give them separate ids
    d3.selectAll(".handle").attr("id",function(d,i){return 'handle'+i})


    // Keyboard accessibility

    // d3.select('body').on('keydown',function(){
    //   if(document.getElementById("handle0")===document.activeElement){//if handle is focussed
    //     var max = document.getElementById('value-simple').max
    //     var min = document.getElementById('value-simple').min
    //
    //     if (d3.event.key=='ArrowLeft') {
    //       if(+document.getElementById('value-simple').value-100<min){
    //         sliderSimple.silentValue(min)
    //         document.getElementById("value-simple").value=min
    //       }else{
    //         sliderSimple.silentValue(+document.getElementById('value-simple').value-100)
    //         document.getElementById("value-simple").value=+document.getElementById("value-simple").value-100
    //       }
    //     }
    //     if (d3.event.key=='ArrowUp') {
    //       d3.event.preventDefault();
    //       if(+document.getElementById('value-simple').value+100>max){
    //         sliderSimple.silentValue(max)
    //         document.getElementById("value-simple").value=max
    //       }else{
    //         sliderSimple.silentValue(+document.getElementById('value-simple').value+100)
    //         document.getElementById("value-simple").value=+document.getElementById("value-simple").value+100
    //       }
    //     }
    //     if (d3.event.key=='ArrowRight') {
    //       if(+document.getElementById('value-simple').value+100>max){
    //         sliderSimple.silentValue(max)
    //         document.getElementById("value-simple").value=max
    //       }else{
    //         sliderSimple.silentValue(+document.getElementById('value-simple').value+100)
    //         document.getElementById("value-simple").value=+document.getElementById("value-simple").value+100
    //       }              }
    //     if (d3.event.key=='ArrowDown') {
    //       d3.event.preventDefault();
    //       if(+document.getElementById('value-simple').value-100<min){
    //         sliderSimple.silentValue(min)
    //         document.getElementById("value-simple").value=min
    //       }else{
    //         sliderSimple.silentValue(+document.getElementById('value-simple').value-100)
    //         document.getElementById("value-simple").value=+document.getElementById("value-simple").value-100
    //       }
    //     }
    //     if (d3.event.key=='PageDown') {
    //       d3.event.preventDefault();
    //       if(+document.getElementById('value-simple').value-1000<min){
    //         sliderSimple.silentValue(min)
    //         document.getElementById("value-simple").value=min
    //       }else{
    //         sliderSimple.silentValue(+document.getElementById('value-simple').value-1000)
    //         document.getElementById("value-simple").value=+document.getElementById("value-simple").value-1000
    //       }
    //     }
    //     if (d3.event.key=='PageUp') {
    //       d3.event.preventDefault();
    //       if(+document.getElementById('value-simple').value+1000>max){
    //         sliderSimple.silentValue(max)
    //         document.getElementById("value-simple").value=max
    //       }else{
    //         sliderSimple.silentValue(+document.getElementById('value-simple').value+1000)
    //         document.getElementById("value-simple").value=+document.getElementById("value-simple").value+1000
    //       }              }
    //     if (d3.event.key=='Home') {
    //       d3.event.preventDefault();
    //       sliderSimple.silentValue(min)
    //       document.getElementById("value-simple").value=min
    //     }
    //     if (d3.event.key=='End') {
    //       d3.event.preventDefault();
    //       sliderSimple.silentValue(max)
    //       document.getElementById("value-simple").value=max
    //     }
    //   }
    // })

    function drawGraphic(){
      //adjust the sliders to match the width of the body
      // gSimple.call(sliderSimple)
      //
      // gSimple2.call(sliderWomen)
      //
      // gSimple3.call(sliderPension)
      //
      // gSimple4.call(sliderMortality)


      //load all the necessary csv files
      //using Promise.all fetches all the csvs at the same time then only return the promise once all the files have been retrieved.
      Promise.all([
        d3.csv("principal-male-mortality.csv"),
        d3.csv("principal-female-mortality.csv"),
        d3.csv("principal-male-migration.csv"),
        d3.csv("principal-female-migration.csv"),
        d3.csv("principal-fertility-rate.csv"),
        d3.csv("population-male.csv"),
        d3.csv("population-female.csv"),
        d3.csv("low-male-mortality.csv"),
        d3.csv("low-female-mortality.csv"),
        d3.csv("mediumlow-male-mortality.csv"),
        d3.csv("mediumlow-female-mortality.csv"),
        d3.csv("mediumhigh-male-mortality.csv"),
        d3.csv("mediumhigh-female-mortality.csv"),
        d3.csv("high-male-mortality.csv"),
        d3.csv("high-female-mortality.csv")
      ])
      .then(function(data){
        malemortalitydata={
          principal:data[0],
          low:data[7],
          mediumlow:data[9],
          mediumhigh:data[11],
          high:data[13]
        }

        femalemortalitydata={
          principal:data[1],
          low:data[8],
          mediumlow:data[10],
          mediumhigh:data[12],
          high:data[14]
        }

        // malemortality=data[0],
        // femalemortality=data[1]
        malemigration=data[2]
        femalemigration=data[3]
        fertility=data[4],
        malepopulation=data[5],
        femalepopulation=data[6]
        mortalityprofile="principal"

        malemortality=malemortalitydata[mortalityprofile]
        femalemortality=femalemortalitydata[mortalityprofile]

        //do some reformatting of the data
        malemortality.forEach(function(d,i){
          for(var column in malemortality[0]){
            malemortality[i][column]=+malemortality[i][column]
          }
        })

        femalemortality.forEach(function(d,i){
          for(var column in femalemortality[0]){
            femalemortality[i][column]=+femalemortality[i][column]
          }
        })

        malemigration.forEach(function(d){
          d["2017"]=+d["2017"]
        })
        femalemigration.forEach(function(d){
          d["2017"]=+d["2017"]
        })
        fertility.forEach(function(d){
          d["2017"]=+d["2017"]
        })

        malepopulation.forEach(function(d){
          d["mid-2016"]=+d["mid-2016"]
        })

        femalepopulation.forEach(function(d){
          d["mid-2016"]=+d["mid-2016"]
        })

        //array with all the years in it
        numberofyears=[]
        for(var column in malemortality[0]){
          if(column=="AGE") continue;
          numberofyears.push(+column)
        }
        // console.log("number of years",numberofyears)

        //array with all the ages for population in it
        populationAgeRange=[]
        malemortality.forEach(function(d){
          populationAgeRange.push(d.AGE)
        })
        // console.log("population age range",populationAgeRange)

        //array with all the ages for fertility
        birthAgeRange=[]
        fertility.forEach(function(d){
          birthAgeRange.push(d.AGE)
        })
        // console.log(birthAgeRange)

        //copy the age range for population but remove -1
        migrationAgeRange=_.clone(populationAgeRange)
        migrationAgeRange.shift()
        // console.log("migrationAgeRange",migrationAgeRange)

        //total up migration
        sumMaleMigration=malemigration.reduce(function(sum,step){return sum+step["2017"]},0)
        sumFemaleMigration=femalemigration.reduce(function(sum,step){return sum+step["2017"]},0)

        totalMigration=sumMaleMigration+sumFemaleMigration
      })
      .then(function(){

        d3.selectAll('input').on("change",function(){
        //   // console.log("input changing")
        //
        //   // Promise.all([d3.csv("principal-male-migration.csv"),d3.csv("principal-female-migration.csv")])
        //   // .then(function(data){
        //   //   console.log(data)
        //   // })
        //   // .then(function(){
        //   //   console.log("rerun the model")
        //   //   console.log("update the line")
        //   // })
        //
          slidervalues=getSliderValues()
          if(slidervalues[4]!=mortalityprofile){
            //load new mortality profiles
              malemortality=malemortalitydata[slidervalues[4].replace(/\s/g,'')]
              femalemortality=femalemortalitydata[slidervalues[4].replace(/\s/g,'')]

              //do some reformatting of the data
              malemortality.forEach(function(d,i){
                for(var column in malemortality[0]){
                  malemortality[i][column]=+malemortality[i][column]
                }
              })

              femalemortality.forEach(function(d,i){
                for(var column in femalemortality[0]){
                  femalemortality[i][column]=+femalemortality[i][column]
                }
              })

              var newOADR=runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,slidervalues[0],slidervalues[1],slidervalues[2],slidervalues[3])

              svg.select('.line')
                  .attr('stroke-dasharray','5 5')
                  .style("stroke", "grey")

              svg.select('.newline')
                  .attr('d', line(newOADR))

              mortalityprofile=slidervalues[4]

          }else{
            //just use the existing mortality profiles
            var newOADR=runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,slidervalues[0],slidervalues[1],slidervalues[2],slidervalues[3])

            svg.select('.line')
                .attr('stroke-dasharray','5 5')
                .style("stroke", "grey")

            svg.select('.newline')
                .attr('d', line(newOADR))
            //set the mortalityprofile
            mortalityprofile=slidervalues[4]
          }
        })//end of on change

        slidervalues=getSliderValues();

        // console.log("run the model")
        var OADR=runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,165000,1.84,2028,67)
        // console.log("draw the line")

        var margin = {	top: 	20,
             right: 	20,
             bottom: 50,
             left: 	50
           };
        var aspectRatio=[16,9]
        var mobileAspectRatio=[4,3]

        if(width<768){
          var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
          var height = Math.ceil((chart_width * mobileAspectRatio[1]) / mobileAspectRatio[0]) - margin.top - margin.bottom;

        }else{
          var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
          // var height = Math.ceil((chart_width * aspectRatio[1]) / aspectRatio[0]) - margin.top - margin.bottom;
          var height = parseInt(keypoints.style("height")) - margin.top - margin.bottom-40;
        }

        var x = d3.scaleTime()
               .range([0, chart_width]);

        y = d3.scaleLinear()
               .range([height, 0]);
        //
        x.domain(d3.extent(numberofyears,function(d){return d3.timeParse("%Y")(d)}));
        //
        var xAxis = d3.axisBottom(x).ticks(5)

        var yAxis = d3.axisLeft(y).ticks(5);
        //
        //gridlines
        var y_axis_grid = function() { return yAxis; }
        //
        //
        line = d3.line()
               .curve(d3.curveLinear)
               .x(function(d) { return x(d.year); })
               .y(function(d) { return y(d.oadr); });

        // y.domain(d3.extent(OldAgeDependencyRatio,function(d){return d.oadr}));
        y.domain([0,550])
        //
        //    //create svg for chart

        d3.select('#graphic').selectAll("*").remove()
        d3.select('#graphic').append('svg').append('g').attr('id',"legend")

        var svg = d3.select('#graphic').select('svg')
                    .attr("width", chart_width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom )
                    .append("g")
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


       svg.append("rect")
         .style("fill", "#fff")
         .attr("width", chart_width)
         .attr("height", height);

         svg.append('g')
             .attr('class', 'x axis')
             .attr('transform','translate(0 '+height+')')
             .call(xAxis);

        svg.append('g')
              .attr('class', 'y axis')
              .call(yAxis);

         svg.append('g')
             .attr('class', 'y grid')
             .call(y_axis_grid()
                 .tickSize(-chart_width, 0, 0)
                 .tickFormat('')
             );

       //y axis label
          // svg.append("text")
          //  //.attr('class', 'unit')
          //  .attr('transform','translate(' + -margin.left + ',-17)') // " + eval(-margin.top + (lineNo+1)*20) + "
          //  .attr("font-size","18px")
          //  .attr("fill","#321213")
          //  .text("Number of pensioners per 1,000 people of working age");

      //create lines
       svg.append('g')
           .append('path')
           .attr('class', 'line')
           .style("stroke", "steelblue")
           .style("fill", 'none')
           .style("stroke-width", 3)
           .style("stroke-linecap", 'round')
           .style("stroke-linejoin", 'round')
           .attr('d', function(d) {
               return line(OADR);
           });

       svg.append('g')
           .append('path')
           .attr('class', 'newline')
           .style("stroke", "steelblue")
           .style("fill", 'none')
           .style("stroke-width", 3)
           .style("stroke-linecap", 'round')
           .style("stroke-linejoin", 'round')

           console.log(OADR)

       svg.append('g')
        .append('circle')
        .attr('id','endcircle')
        .attr('cx',x(new Date("2042")))
        .attr('cy',y(OADR[OldAgeDependencyRatio.length-1].oadr))
        .attr('r',5)
        .attr('fill','#206095')

      createLegend()

      })//end initial promise





      //use pym to calculate chart dimensions
       if (pymChild) {
           pymChild.sendHeight();
       }

    }//ends draw graphic

    function getSliderValues(){
      var netmigration=+document.getElementById('migrationHidden').value
      var totalfertility=+document.getElementById('fertilityHidden').value
      var year=+document.getElementById('yearHidden').value
      var pensionage=+document.getElementById('pensionHidden').value
      var mortality=ticks[+document.getElementById('mortalityHidden').value]

      return [netmigration,totalfertility,year,pensionage,mortality]
    }

    function runthemodel(malemortality,femalemortality,malemigration,femalemigration,fertility,malepopulation,femalepopulation,netMigrationTarget,totalFertilityTarget,customPensionYear,customPensionAge){

      //work out migration scale factors
      targetMigrationScale=netMigrationTarget/totalMigration
      migrationScaleFactors=numberofyears.map(function(d,i){
        return {year:d,msf:1-(i*(1-targetMigrationScale)/(numberofyears.length-1))}
      })

      //create the structure for the migration
      migration=[]
      numberofyears.forEach(function(d){
        migration.push({year:d,values:[]})
      })

      //for each year, work out the migration, which is migration*scale factor
      numberofyears.forEach(function(c){
        var array = migration.filter(function(d){
          return d.year==c
        }).map(function(e){
          return e["values"]
        })

      migrationAgeRange.forEach(function(d){
          array[0].push({
            "age":d,
            "male":Math.round(
              malemigration.filter(function(e){return e.AGE==d}).map(function(f){return f["2017"]})[0]*migrationScaleFactors.filter(function(d){return d.year==c}).map(function(d){return d.msf})[0]
            ),
            "female":Math.round(
              femalemigration.filter(function(e){return e.AGE==d}).map(function(f){return f["2017"]})[0]*migrationScaleFactors.filter(function(d){return d.year==c}).map(function(d){return d.msf})[0]
            )
          })
        })
      })//end of numberofyears.forEach

      //Calculate TFR
      totalFertilityRate=fertility.reduce(function(sum,step){return sum+step["2017"]},0)/1000

      //Work out fertility rates
      targetFertilityScale=totalFertilityTarget/totalFertilityRate
      fertilityScaleFactors=numberofyears.map(function(d,i){
        return {year:d,fsf:1-(i*(1-targetFertilityScale)/(numberofyears.length-1))}
      })

      //create the data structure for fertility
      birthrate=[]
      numberofyears.forEach(function(d){
        birthrate.push({year:d,values:[]})
      })

      //work out the birth rate for each age and each year with the fertility and scale factors
      numberofyears.forEach(function(c){
        var array = birthrate.filter(function(d){
          return d.year==c
        }).map(function(e){
          return e["values"]
        })[0]
        birthAgeRange.forEach(function(d){
          array.push({"age":d,
          "fertilityrate":fertility.filter(function(e){return e.AGE==d}).map(function(f){return f["2017"]})[0]*fertilityScaleFactors.filter(function(d){return d.year==c}).map(function(d){return d.fsf})[0]
          })
        })
      })//end numberofyears.forEach

      // console.log("birth rate", birthrate)

      //set up all the arrays to hold the different bits of data
      deaths=[]
      numberofyears.forEach(function(d){
        deaths.push({year:d,values:[]})
      })

      interimAgeRange=_.clone(migrationAgeRange)
      interimAgeRange.shift()
      // console.log("interim age range",interimAgeRange)

      interim=[]
      numberofyears.forEach(function(d){
        interim.push({year:d,values:[]})
      })

      babies=[]
      numberofyears.forEach(function(d){
        babies.push({year:d,values:[]})
      })

      population=[];

      //put the male and female population from the csv into our data format
      population.push({year:2016,values:[]})
      var fox = population.filter(function(e){return e.year==2016;}).map(function(e){return e.values})
      malepopulation.forEach(function(d){
        fox[0].push({
          age:+d.Age,
          male:d["mid-2016"],
          female:femalepopulation.filter(function(e){return e.Age==d.Age})
          .map(function(e){return e["mid-2016"]})[0]
        })
      })

      numberofyears.forEach(function(d){
        population.push({year:d,values:[]})
      })

      //     BIG      ///////////////////////////////////////////////////
      //     LOOP     ///////////////////////////////////////////////////
      //     HERE     ///////////////////////////////////////////////////
      //     !!!!     ///////////////////////////////////////////////////
      //     !!!!     ///////////////////////////////////////////////////
      numberofyears.forEach(function(a){

          // lets work out how many people died
          var cat=deaths.filter(function(d){return d.year==a})
          .map(function(e){
            return e["values"]
          })

          //use migration age range as it starts from 0-125, then work out neonatal deaths later
          migrationAgeRange.forEach(function(d){
            cat[0].push({
              "age":d,
               "male":
               Math.round(
                 (
                   population.filter(function(e){return e.year==a-1})
                   .map(function(e){return e.values})[0]
                   .filter(function(e){return e.age==d})
                   .map(function(e){return e.male})[0]
                   +migration.filter(function(e){return e.year==a})
                   .map(function(e){return e.values})[0]
                   .filter(function(e){return e.age==d})
                   .map(function(e){return e.male})[0]
                 )
                 *malemortality.filter(function(e){
                   return e.AGE==d
                 }).map(function(e){return e[a]})[0]
                 /100000
            ),
              "female":
              Math.round(
                (
                  population.filter(function(e){return e.year==a-1})
                  .map(function(e){return e.values})[0]
                  .filter(function(e){return e.age==d})
                  .map(function(e){return e.female})[0]
                  +migration.filter(function(e){return e.year==a})
                  .map(function(e){return e.values})[0]
                  .filter(function(e){return e.age==d})
                  .map(function(e){return e.female})[0]
                )
                *femalemortality.filter(function(e){
                  return e.AGE==d
                }).map(function(e){return e[a]})[0]
                /100000
              )
            })
          })

          // work out interim population
          var bee=interim.filter(function(d){
            return d.year==a
          }).map(function(e){
            return e["values"]
          })

          interimAgeRange.forEach(function(d){
              bee[0].push({"age":d,
              male:
              //males population
              population.filter(function(e){return e.year==a-1})
              .map(function(e){return e.values})[0]
              .filter(function(e){return e.age==d-1})
              .map(function(e){return e.male})[0]
              //minus deaths
              -
              deaths.filter(function(e){return e.year==a})
              .map(function(e){return e["values"].filter(function(f){return f.age==d-1})
              .map(function(f){return f.male})[0]})[0]
              //add in migration
              +
              Math.round(
                (
                  migration.filter(function(e){return e.year==a})
                  .map(function(e){return e.values})[0]
                  .filter(function(e){return e.age==d})
                  .map(function(e){return e.male})[0]
                  +
                  migration.filter(function(e){return e.year==a})
                  .map(function(e){return e.values})[0]
                  .filter(function(e){return e.age==d-1})
                  .map(function(e){return e.male})[0]
                )/2
              )  ,
              female:
              population.filter(function(e){return e.year==a-1})
              .map(function(e){return e.values})[0]
              .filter(function(e){return e.age==d-1})
              .map(function(e){return e.female})[0]
              //minus deaths
              -
              deaths.filter(function(e){return e.year==a})
              .map(function(e){return e["values"].filter(function(f){return f.age==d-1})
              .map(function(f){return f.female})[0]})[0]
              //add in migration
              +
              Math.round(
                (
                  migration.filter(function(e){return e.year==a})
                  .map(function(e){return e.values})[0]
                  .filter(function(e){return e.age==d})
                  .map(function(e){return e.female})[0]
                  +
                  migration.filter(function(e){return e.year==a})
                  .map(function(e){return e.values})[0]
                  .filter(function(e){return e.age==d-1})
                  .map(function(e){return e.female})[0]
                )/2
              )
              })
          })

          // work out how many babies were born
          var dogs = babies.filter(function(d){
            return d.year==a
          }).map(function(e){
            return e["values"]
          })

          birthAgeRange.forEach(function(d){
            dogs[0].push({
              "age":d,
              "births":
              Math.round(
                (
                  (
                    population.filter(function(e){return e.year==a-1})
                    .map(function(e){return e.values})[0]
                    .filter(function(e){return e.age==d})
                    .map(function(e){return e.female})[0]
                    +
                    interim.filter(function(e){return e.year==a})
                    .map(function(e){return e.values})[0]
                    .filter(function(e){return e.age==d})
                    .map(function(e){return e.female})[0]
                  )/2
                  *
                  birthrate
                  .filter(function(e){return e.year==a})
                  .map(function(e){return e.values})[0]
                  .filter(function(e){return e.age==d})
                  .map(function(e){return e.fertilityrate})[0]
                )/1000
              )
            })
          })

          //work out the total births
          var addTotalBirths=babies.filter(function(e){return e.year==a})

          addTotalBirths[0]["total"]=
            babies.filter(function(e){return e.year==a})
            .map(function(e){return e.values})[0]
            .reduce(function(sum,step){return sum+step.births},0)

          // and work how many were male and female
          addTotalBirths[0]["totalMale"]=Math.round(addTotalBirths[0]["total"]*0.51219512195122)

          addTotalBirths[0]["totalFemale"]=addTotalBirths[0]["total"]-addTotalBirths[0]["totalMale"]

          //work out premature deaths
          deaths.filter(function(e){return e.year==a})
          .map(function(e){return e.values})[0]
          .push(
            {
              age:"-1",
              male:
              Math.round(
                babies.filter(function(e){return e.year==a})
                .map(function(e){return e.totalMale})[0]
                *
                malemortality.filter(function(e){return e.AGE=="-1"})
                .map(function(e){return e[a]})[0]
                /100000
              )
              ,
              female:
              Math.round(
                babies.filter(function(e){return e.year==a})
                .map(function(e){return e.totalFemale})[0]
                *
                femalemortality.filter(function(e){return e.AGE=="-1"})
                .map(function(e){return e[a]})[0]
                /100000
              )
            }
          )

          // add it all together as one big thing
          var eagle=population.filter(function(e){return e.year==a})
          .map(function(e){return e.values})

          //do age 0 first
          eagle[0].push(
            {
              age:0,
              male:babies.filter(function(e){return e.year==a})
              .map(function(e){return e.totalMale})[0]
              -
              deaths.filter(function(e){return e.year==a})
              .map(function(e){return e.values})[0]
              .filter(function(e){return e.age=="-1"})
              .map(function(e){return e.male})[0]
              +
              migration.filter(function(e){return e.year==a})
              .map(function(e){return e.values})[0]
              .filter(function(e){return e.age==0})
              .map(function(e){return e.male})[0],

              female:babies.filter(function(e){return e.year==a})
              .map(function(e){return e.totalFemale})[0]
              -
              deaths.filter(function(e){return e.year==a})
              .map(function(e){return e.values})[0]
              .filter(function(e){return e.age=="-1"})
              .map(function(e){return e.female})[0]
              +
              migration.filter(function(e){return e.year==a})
              .map(function(e){return e.values})[0]
              .filter(function(e){return e.age==0})
              .map(function(e){return e.female})[0]
            }
          )

          //then for the rest of the ages
          interimAgeRange.forEach(function(d){
            eagle[0].push(
              { age:d,
                male:interim.filter(function(e){return e.year==a})
                .map(function(e){return e.values})[0]
                .filter(function(e){return e.age==d})
                .map(function(e){return e.male})[0],
                female:interim.filter(function(e){return e.year==a})
                .map(function(e){return e.values})[0]
                .filter(function(e){return e.age==d})
                .map(function(e){return e.female})[0]
              }
            )
          })

    })//end of massive numberofyears loop

    //work out pension age for each year
    pensionAge=[];

    pensionAge.push({year:2016,men:65,women:64})
    numberofyears.forEach(function(d){

      if(d<customPensionYear){
        var malePensionAge,femalePensionAge;

        if(d<2019){malePensionAge=65}else if(d>=2019&&d<2026){malePensionAge=66}else{malePensionAge=67}

        if(d==2016||d==2017){femalePensionAge=64}else if(d==2018){femalePensionAge=65}else if(d>2018&&d<2026){femalePensionAge=66}else{femalePensionAge=67}

        pensionAge.push({
          year:d,
          men:malePensionAge,
          women:femalePensionAge
        })
      }else{
        pensionAge.push({
          year:d,
          men:customPensionAge,
          women:customPensionAge
        })
      }
    })

    //work out how many pensioners and workers there were
    pensioners=[]
    numberofyears.forEach(function(d){
      pensioners.push({year:d,values:[]})
    })

    numberofyears.forEach(function(d){
      var fish=pensioners.filter(function(e){return e.year==d})
      .map(function(e){return e.values})

      var malepensionageforyear=pensionAge.filter(function(e){
        return e.year==d
      }).map(function(e){return e.men})[0]

      var femalepensionageforyear=pensionAge.filter(function(e){
        return e.year==d
      }).map(function(e){return e.women})[0]

      var populationforthisyear=population.filter(function(e){
        return e.year==d
      })[0].values


      //corrections for sliding pension start date
      if(d==2016){
        if(femalepensionageforyear==64){
          var femalecorrectionforthisyear=Math.round(populationforthisyear
          .filter(function(e){return e.age==(femalepensionageforyear-1)})[0].female*0.7644)
        }else{var femalecorrectionforthisyear=0}
      }
      else if(d==2017){
        if(femalepensionageforyear==64){
          var femalecorrectionforthisyear=Math.round(populationforthisyear
          .filter(function(e){return e.age==(femalepensionageforyear-1)})[0].female*0.0137)
        }else{var femalecorrectionforthisyear=0}
      }
      else if(d==2018){
        if(femalepensionageforyear==65){
          var femalecorrectionforthisyear=Math.round(populationforthisyear
          .filter(function(e){return e.age==(femalepensionageforyear-1)})[0].female*0.2658)
        }else{var femalecorrectionforthisyear=0}
      }
      else if(d==2019){
        if(femalepensionageforyear==66){
          var femalecorrectionforthisyear=Math.round(populationforthisyear
          .filter(function(e){return e.age==(femalepensionageforyear-1)})[0].female*0.60274)
        }else{var femalecorrectionforthisyear=0}
      }
      else if(d==2020){
        if(femalepensionageforyear==66){
          var femalecorrectionforthisyear=Math.round(populationforthisyear
          .filter(function(e){return e.age==(femalepensionageforyear-1)})[0].female*0.09863)
        }else{var femalecorrectionforthisyear=0}
      }else if(d==2026){
        if(femalepensionageforyear==67){
          var femalecorrectionforthisyear=Math.round(populationforthisyear
          .filter(function(e){return e.age==(femalepensionageforyear-1)})[0].female*0.84699)
        }else{var femalecorrectionforthisyear=0}
      }else if(d==2027){
        if(femalepensionageforyear==67){
          var femalecorrectionforthisyear=Math.round(populationforthisyear
          .filter(function(e){return e.age==(femalepensionageforyear-1)})[0].female*0.35068)
        }else{var femalecorrectionforthisyear=0}
      }
      else{var femalecorrectionforthisyear=0}


      if(d==2019){
        if(malepensionageforyear==66){
          var malecorrectionforthisyear=Math.round(populationforthisyear
          .filter(function(e){return e.age==(malepensionageforyear-1)})[0].male*0.60274)
        }else{var malecorrectionforthisyear=0}
      }else if(d==2020){
        if(malepensionageforyear==66){
          var malecorrectionforthisyear=Math.round(populationforthisyear
          .filter(function(e){return e.age==(malepensionageforyear-1)})[0].male*0.09863)
        }else{var malecorrectionforthisyear=0}
      }else if(d==2026){
        if(malepensionageforyear==67){
          var malecorrectionforthisyear=Math.round(populationforthisyear
          .filter(function(e){return e.age==(malepensionageforyear-1)})[0].male*0.84699)
        }else{var malecorrectionforthisyear=0}
      }else if(d==2027){
        if(malepensionageforyear==67){
          var malecorrectionforthisyear=Math.round(populationforthisyear
          .filter(function(e){return e.age==(malepensionageforyear-1)})[0].male*0.35068)
        }else{var malecorrectionforthisyear=0}
      }else{
        var malecorrectionforthisyear=0
      }



      fish[0].push({
            malepensioners:populationforthisyear
            .filter(function(e){
               return e.age>=malepensionageforyear
            })
            .reduce(function(sum,step){return sum=sum+step.male},0)+malecorrectionforthisyear
            ,
            femalepensioners:populationforthisyear
            .filter(function(e){
               return e.age>=femalepensionageforyear
            })
            .reduce(function(sum,step){return sum=sum+step.female},0)+femalecorrectionforthisyear

            ,
            maleworkers:populationforthisyear
            .filter(function(e){
              return e.age>=16&&e.age<malepensionageforyear
            })
            .reduce(function(sum,step){return sum=sum+step.male},0)-malecorrectionforthisyear
            ,
            femaleworkers:populationforthisyear
            .filter(function(e){
              return e.age>=16&&e.age<femalepensionageforyear
            })
            .reduce(function(sum,step){return sum=sum+step.female},0)-femalecorrectionforthisyear
        })
    })



    OldAgeDependencyRatio = []
    numberofyears.forEach(function(d){
      var thisyear=pensioners.filter(function(e){
        return e.year==d
      })[0].values[0]

      OldAgeDependencyRatio.push({
        year:d3.timeParse("%Y")(d),
        oadr:((thisyear.malepensioners+thisyear.femalepensioners)/(thisyear.maleworkers+thisyear.femaleworkers))*1000
      })
    })
    return OldAgeDependencyRatio
  }//ends run the model

  function updateText(OADR){
    var svg=d3.select("#graphic")

    svg.select("path.newline").transition().ease(d3.easeCubic).duration(500)
      .attr("d",line(OADR))

    svg.select("#endcircle").transition().ease(d3.easeCubic).duration(500)
      .attr('cy',y(OADR[OADR.length-1].oadr))


    var OADRin2042=d3.format(".0f")(OADR[OADR.length-1].oadr)
    var selectBox=d3.select('#keypoints')
    selectBox.select('#boxtext1').html(OADRin2042)

    var changeAgainstProjections = OADRin2042-367
    selectBox.select('#boxtext2').html(Math.abs(changeAgainstProjections))

    // if(changeAgainstProjections>0){
    //   selectBox.select('#boxtext3').html('more than')
    // }else if(changeAgainstProjections<0){
    //   selectBox.select('#boxtext3').html('less than')
    // }else{
    //   selectBox.select('#boxtext2').html("")
    //   selectBox.select('#boxtext3').html('equal to')
    // }

    var changeAgainst2016 = OADRin2042-300
    selectBox.select('#boxtext4').html(Math.abs(changeAgainst2016))

    if(changeAgainst2016>0){
      selectBox.select('#boxtext5').html('more than in')
      selectBox.select('#boxtext2').html("increase")
    }else if(changeAgainst2016<0){
      selectBox.select('#boxtext5').html('less than in')
      selectBox.select('#boxtext2').html("decrease")
    }else{
      selectBox.select('#boxtext4').html("")
      selectBox.select('#boxtext5').html('equal to')
      selectBox.select('#boxtext2').html("equal ")
    }

  }//end function updateText(OADR)

function setupSliders(){
  //function to be called when switching desktop to mobile
}



function createLegend(){
  var prevX= 0;
  var prevY= 0;
  lineNo = 0;
  var lineNoOld = 0;
  var colours=["#206095","grey"]
  var legendLabels=["Your projection", "Our projection"]
  legendLabels.forEach(function(d,i) {
  var_group= d3.select("#legend").append("g")
  .attr("transform", "translate(0,-10)")
  var_group.append("line")
    .attr("class","rect" + i)
    .style("stroke", colours[i])
    .attr("x1", 0)
    .attr("x2",20)
    .attr("y1", 14)
    .attr("y2",14)
    .attr("stroke-width",3)
    .attr("stroke-dasharray",function(){if(i==1){return "5 5"}})
  var_group.append("text")
    .text(legendLabels[i])
    .attr("class","legend" + i)
    .attr("text-anchor", "start")
    .style("font-size", "18px")
    .style("fill", colours[i])
    .attr('y',15)
    .attr('x',0);
  d3.selectAll(".legend" + (i))
    .each(calcPosition);

    function calcPosition() {
      var BBox = this.getBBox()
      //prevY =BBox.width
      d3.select(".legend" + (i))
      .attr("y",function(d){
      if((prevX+BBox.width +50)>parseInt(graphic.style("width")) ){
      lineNoOld = lineNo;
      lineNo=lineNo + 1;
      prevX = 0;
      }
      return eval((lineNo*20) + 20);
      })
      .attr("x",function(d){ return prevX+25;})
      d3.select(".rect" + (i))
      .attr("y",function(d){
      if((prevX+BBox.width +50)>parseInt(graphic.style("width")) ){
      lineNoOld = lineNo;
      lineNo=lineNo + 1;
      prevX = 0;
      }
      return eval((lineNo*20)+5);
      })
      .attr("x1",function(d){ return prevX; })
      .attr("x2",function(d){ return prevX+20; })

      prevX = prevX + BBox.width +50
      }; // end function calcPosition()
  }); // end foreach
}// end function createLegend()

	//check whether browser can cope with svg
		if (Modernizr.svg) {
			//use pym to create iframed chart dependent on specified variables
			pymChild = new pym.Child({ renderCallback: drawGraphic});
		} else {
			 //use pym to create iframe containing fallback image (which is set as default)
			 pymChild = new pym.Child();
			if (pymChild) {
		        pymChild.sendHeight();
		  }
		}
    </script>
</body>
</html>
